<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>エレベーター管理システム</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        h2 {
            margin-top: 30px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #f0f0f0;
        }

        .realtime {
            display: flex;
            gap: 40px;
        }

        .realtime>div {
            flex: 1;
        }

        .download-btn {
            margin-bottom: 10px;
        }

        .scrollable-table {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>エレベーター管理システム</h1>
    <h2>リアルタイム情報</h2>
    <div class="realtime">
        <div>
            <h3>各階の最新混雑度</h3>
            <div class="scrollable-table">
                <table id="congestion-table">
                    <thead>
                        <tr>
                            <th>階</th>
                            <th>混雑度</th>
                            <th>時刻</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div>
            <h3>最新エレベーター環境</h3>
            <div class="scrollable-table">
                <table id="env-table">
                    <thead>
                        <tr>
                            <th>デバイス</th>
                            <th>気圧</th>
                            <th>温度</th>
                            <th>湿度</th>
                            <th>時刻</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <h2>過去データ</h2>
    <div>
        <button class="download-btn" onclick="downloadCSV()">CSVダウンロード</button>
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div style="flex:1; min-width:300px;">
                <h4>混雑度</h4>
                <canvas id="congestionChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>気圧</h4>
                <canvas id="pressureChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>温度</h4>
                <canvas id="tempChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>湿度</h4>
                <canvas id="humChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>事故情報</h4>
                <canvas id="accidentChart" height="100"></canvas>
            </div>
        </div>
        <div style="margin: 10px 0;">
            <label>表示範囲:
                <select id="rangeSelect" onchange="fetchHistory()">
                    <option value="day">日</option>
                    <option value="week">週</option>
                    <option value="month">月</option>
                    <option value="all">全期間</option>
                </select>
                <input type="date" id="dateInput" value="" onchange="fetchHistory()">
            </label>
        </div>
        <div id="tableArea">
            <h4>混雑度</h4>
            <div id="congestionTableContainer" class="scrollable-table"></div>
            <h4>環境データ</h4>
            <div id="environmentTableContainer" class="scrollable-table"></div>
            <h4>事故情報</h4>
            <div id="accidentTableContainer" class="scrollable-table"></div>
        </div>
    </div>

    <script>
        // 日時をISO8601に変換
        function toISO(dt) {
            return dt ? dt.replace(' ', 'T') : dt;
        }

        // リアルタイムデータ取得
        async function fetchRealtime() {
            const [congestion, env] = await Promise.all([
                fetch('/api/congestion/latest').then(r => r.json()),
                fetch('/api/environment/latest').then(r => r.json())
            ]);

            // 混雑度
            const ct = document.querySelector('#congestion-table tbody');
            ct.innerHTML = congestion.map(row => `<tr><td>${row.floor_number}</td><td>${row.congestion_level}</td><td>${row.measured_at}</td></tr>`).join('');
            document.querySelector('#congestion-table').parentElement.classList.toggle('scrollable-table', congestion.length > 30);

            // 環境
            const et = document.querySelector('#env-table tbody');
            et.innerHTML = env.map(row => `<tr><td>${row.device_id}</td><td>${row.pressure}</td><td>${row.temperature}</td><td>${row.humidity}</td><td>${row.measured_at}</td></tr>`).join('');
            document.querySelector('#env-table').parentElement.classList.toggle('scrollable-table', env.length > 30);
        }

        // グラフの初期化
        let congestionChart, pressureChart, tempChart, humChart, accidentChart;

        function initCharts() {
            const ctxCongestion = document.getElementById('congestionChart').getContext('2d');
            const ctxPressure = document.getElementById('pressureChart').getContext('2d');
            const ctxTemp = document.getElementById('tempChart').getContext('2d');
            const ctxHum = document.getElementById('humChart').getContext('2d');
            const ctxAccident = document.getElementById('accidentChart').getContext('2d');

            congestionChart = new Chart(ctxCongestion, {
                type: 'line',
                data: { labels: [], datasets: [{ label: '混雑度', data: [], borderColor: 'blue', fill: false }] },
                options: { responsive: true, scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
            });

            pressureChart = new Chart(ctxPressure, {
                type: 'line',
                data: { labels: [], datasets: [{ label: '気圧', data: [], borderColor: 'green', fill: false }] },
                options: { responsive: true, scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
            });

            tempChart = new Chart(ctxTemp, {
                type: 'line',
                data: { labels: [], datasets: [{ label: '温度', data: [], borderColor: 'red', fill: false }] },
                options: { responsive: true, scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
            });

            humChart = new Chart(ctxHum, {
                type: 'line',
                data: { labels: [], datasets: [{ label: '湿度', data: [], borderColor: 'purple', fill: false }] },
                options: { responsive: true, scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
            });

            accidentChart = new Chart(ctxAccident, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: '事故件数', data: [], backgroundColor: 'orange' }] },
                options: { responsive: true, scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
            });
        }

        // 過去データ取得
        async function fetchHistory(page = 1) {
            const range = document.getElementById('rangeSelect').value;
            const date = document.getElementById('dateInput').value;
            let url = `/api/history?page=${page}`;
            if (range && date) {
                url += `&range=${range}&date=${date}`;
            }
            const res = await fetch(url);
            const result = await res.json();
            const data = result.data;

            // 混雑度
            const congestion = data.filter(row => row.congestion_level !== undefined && row.congestion_level !== null);

            // 環境データ
            const environment = data.filter(row => row.pressure !== undefined && row.pressure !== null);

            // 混雑度データを階ごとにグループ化
            const groupedByFloor = {};
            congestion.forEach(row => {
                if (!groupedByFloor[row.floor_number]) {
                    groupedByFloor[row.floor_number] = [];
                }
                groupedByFloor[row.floor_number].push(row);
            });

            // グラフデータ更新
            congestionChart.data.labels = [...new Set(congestion.map(row => row.measured_at))];
            congestionChart.data.datasets = Object.keys(groupedByFloor).map((floor, index) => ({
                label: `階 ${floor}`,
                data: groupedByFloor[floor].map(row => row.congestion_level),
                borderColor: `hsl(${(index * 60) % 360}, 70%, 50%)`, // 階ごとに異なる色
                fill: false
            }));
            congestionChart.update();

            pressureChart.data.labels = environment.map(row => row.measured_at);
            pressureChart.data.datasets[0].data = environment.map(row => row.pressure);
            pressureChart.update();

            tempChart.data.labels = environment.map(row => row.measured_at);
            tempChart.data.datasets[0].data = environment.map(row => row.temperature);
            tempChart.update();

            humChart.data.labels = environment.map(row => row.measured_at);
            humChart.data.datasets[0].data = environment.map(row => row.humidity);
            humChart.update();

            accidentChart.data.labels = accidentTable.map(row => row.occurred_at);
            accidentChart.data.datasets[0].data = accidentTable.map(row => 1); // 件数を1でカウント
            accidentChart.update();
        }
        // CSVダウンロード
        async function downloadCSV() {
            const result = await fetch('/api/history').then(r => r.json());
            const data = result.data || result; // 互換
            let csv = '階/デバイス,混雑度,気圧,温度,湿度,時刻\n';
            csv += data.map(row => `${row.device_id || row.floor_number},${row.congestion_level || ''},${row.pressure || ''},${row.temperature || ''},${row.humidity || ''},${row.measured_at}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'history.csv';
            a.click();
        }
        // 初期ロード
        // 今日の日付をデフォルトでセット
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('rangeSelect').value = 'day';
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
            fetchRealtime();
            fetchHistory();
            initCharts();
            setInterval(fetchRealtime, 5000);
        });
    </script>
</body>

</html>