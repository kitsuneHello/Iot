<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>エレベーター管理システム</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        h2 {
            margin-top: 30px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #f0f0f0;
        }

        .realtime {
            display: flex;
            gap: 40px;
        }

        .realtime>div {
            flex: 1;
        }

        .download-btn {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>エレベーター管理システム</h1>
    <h2>リアルタイム情報</h2>
    <div class="realtime">
        <div>
            <h3>各階の最新混雑度</h3>
            <table id="congestion-table">
                <thead>
                    <tr>
                        <th>階</th>
                        <th>混雑度</th>
                        <th>時刻</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div>
            <h3>最新エレベーター環境</h3>
            <table id="env-table">
                <thead>
                    <tr>
                        <th>デバイス</th>
                        <th>CO₂</th>
                        <th>温度</th>
                        <th>湿度</th>
                        <th>時刻</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div>
            <h3>最新混雑RTT指標</h3>
            <div id="rtt-value">取得中...</div>
        </div>
    </div>

    <h2>過去データ</h2>
    <div>
        <button class="download-btn" onclick="downloadCSV()">CSVダウンロード</button>
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div style="flex:1; min-width:300px;">
                <h4>混雑度</h4>
                <canvas id="congestionChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>CO₂</h4>
                <canvas id="co2Chart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>温度</h4>
                <canvas id="tempChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>湿度</h4>
                <canvas id="humChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>RTT指標</h4>
                <canvas id="rttChart" height="100"></canvas>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>事故情報</h4>
                <canvas id="accidentChart" height="100"></canvas>
            </div>
        </div>
        <div style="margin: 10px 0;">
            <label>表示範囲:
                <select id="rangeSelect" onchange="fetchHistory()">
                    <option value="day">日</option>
                    <option value="week">週</option>
                    <option value="month">月</option>
                    <option value="all">全期間</option>
                </select>
                <input type="date" id="dateInput" value="" onchange="fetchHistory()">
            </label>
        </div>
        <div id="tableArea"></div>
    </div>

    <script>
        // 日時をISO8601に変換
        function toISO(dt) {
            return dt ? dt.replace(' ', 'T') : dt;
        }
        // リアルタイムデータ取得
        async function fetchRealtime() {
            const [congestion, env, rtt] = await Promise.all([
                fetch('/api/congestion/latest').then(r => r.json()),
                fetch('/api/environment/latest').then(r => r.json()),
                fetch('/api/rtt/latest').then(r => r.json())
            ]);
            // 混雑度
            const ct = document.querySelector('#congestion-table tbody');
            ct.innerHTML = congestion.map(row => `<tr><td>${row.floor_number}</td><td>${row.congestion_level}</td><td>${row.measured_at}</td></tr>`).join('');
            // 環境
            const et = document.querySelector('#env-table tbody');
            et.innerHTML = env.map(row => `<tr><td>${row.device_id}</td><td>${row.co2_ppm}</td><td>${row.temperature}</td><td>${row.humidity}</td><td>${row.measured_at}</td></tr>`).join('');
            // RTT
            document.getElementById('rtt-value').textContent = rtt.value;
        }
        // 過去データ取得
        async function fetchHistory(page = 1) {
            const range = document.getElementById('rangeSelect').value;
            const date = document.getElementById('dateInput').value;
            let url = `/api/history?page=${page}`;
            if (range && date) {
                url += `&range=${range}&date=${date}`;
            }
            const res = await fetch(url);
            const result = await res.json();
            const data = result.data;
            const totalPages = result.totalPages || 1;
            // --- 表を項目ごとに分割 ---
            let html = '';
            // 混雑度
            const congestion = data.filter(row => row.congestion_level !== undefined && row.congestion_level !== null);
            html += `<h4>混雑度</h4><table><thead><tr><th>階/デバイス</th><th>混雑度</th><th>時刻</th></tr></thead><tbody>`;
            html += congestion.map(row => `<tr><td>${row.device_id || row.floor_number}</td><td>${row.congestion_level || ''}</td><td>${row.measured_at}</td></tr>`).join('');
            html += '</tbody></table>';
            // 環境データ
            const environment = data.filter(row => row.co2_ppm !== undefined && row.co2_ppm !== null);
            html += `<h4>環境データ</h4><table><thead><tr><th>デバイス</th><th>CO₂</th><th>温度</th><th>湿度</th><th>時刻</th></tr></thead><tbody>`;
            html += environment.map(row => `<tr><td>${row.device_id}</td><td>${row.co2_ppm}</td><td>${row.temperature}</td><td>${row.humidity}</td><td>${row.measured_at}</td></tr>`).join('');
            html += '</tbody></table>';
            // 事故情報
            const accidentTable = data.filter(row => row.accident_type !== undefined && row.accident_type !== null);
            html += `<h4>事故情報</h4><table><thead><tr><th>デバイス</th><th>事故種別</th><th>発生時刻</th><th>解決</th></tr></thead><tbody>`;
            html += accidentTable.map(row => `<tr><td>${row.device_id}</td><td>${row.accident_type}</td><td>${row.occurred_at}</td><td>${row.is_resolved ? '済' : '未'}</td></tr>`).join('');
            html += '</tbody></table>';
            // ページネーション
            if (totalPages > 1) {
                html += '<div style="margin:10px 0;">';
                for (let i = 1; i <= totalPages; i++) {
                    html += `<button onclick="fetchHistory(${i})"${i === page ? ' style=\"font-weight:bold\"' : ''}>${i}</button> `;
                }
                html += '</div>';
            }
            document.getElementById('tableArea').innerHTML = html;

            // --- グラフ描画 ---
            // 混雑度: 階ごと
            const congestionByFloor = {};
            data.filter(r => r.congestion_level !== null && r.congestion_level !== undefined && r.floor_number !== null && r.floor_number !== undefined)
                .forEach(r => {
                    if (!congestionByFloor[r.floor_number]) congestionByFloor[r.floor_number] = [];
                    congestionByFloor[r.floor_number].push(r);
                });
            const ctxC = document.getElementById('congestionChart').getContext('2d');
            if (ctxC._chart) ctxC._chart.destroy();
            ctxC._chart = new Chart(ctxC, {
                type: 'line',
                data: {
                    datasets: Object.keys(congestionByFloor).map((floor, idx) => ({
                        label: `${floor}F`,
                        data: congestionByFloor[floor].map(r => ({ x: toISO(r.measured_at), y: r.congestion_level })),
                        borderColor: ['blue', 'purple', 'navy', 'teal', 'aqua'][idx % 5],
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            ticks: { autoSkip: true, maxTicksLimit: 8 }
                        }
                    }
                }
            });
            // CO2
            const co2 = data.filter(r => r.co2_ppm !== null && r.co2_ppm !== undefined);
            const temp = data.filter(r => r.temperature !== null && r.temperature !== undefined);
            const hum = data.filter(r => r.humidity !== null && r.humidity !== undefined);
            const rtt = data.filter(r => r.rtt_value !== null && r.rtt_value !== undefined);
            const makeChart = (ctx, label, arr, key, color) => {
                if (!ctx) return;
                if (ctx._chart) { ctx._chart.destroy(); }
                ctx._chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{ label, data: arr.map(r => ({ x: toISO(r.measured_at), y: r[key] })), borderColor: color, fill: false }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                                ticks: { autoSkip: true, maxTicksLimit: 8 }
                            }
                        }
                    }
                });
            };
            makeChart(document.getElementById('co2Chart').getContext('2d'), 'CO₂', co2, 'co2_ppm', 'green');
            makeChart(document.getElementById('tempChart').getContext('2d'), '温度', temp, 'temperature', 'red');
            makeChart(document.getElementById('humChart').getContext('2d'), '湿度', hum, 'humidity', 'orange');
            // RTT
            const ctxR = document.getElementById('rttChart').getContext('2d');
            if (ctxR._chart) ctxR._chart.destroy();
            ctxR._chart = new Chart(ctxR, {
                type: 'line',
                data: {
                    datasets: [{ label: 'RTT', data: rtt.map(r => ({ x: toISO(r.measured_at), y: r.rtt_value })), borderColor: 'black', fill: false }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            ticks: { autoSkip: true, maxTicksLimit: 8 }
                        }
                    }
                }
            });
            // 事故状況グラフ（点プロット）
            const accidentData = data.filter(r => r.accident_type !== undefined && r.accident_type !== null);
            const ctxA = document.getElementById('accidentChart').getContext('2d');
            if (ctxA._chart) ctxA._chart.destroy();
            ctxA._chart = new Chart(ctxA, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '事故発生',
                            data: accidentData.map(r => ({ x: toISO(r.occurred_at), y: 1, accident_type: r.accident_type, device_id: r.device_id })),
                            backgroundColor: 'red',
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const d = context.raw;
                                    return `${d.x} ${d.device_id || ''} ${d.accident_type || ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            title: { display: true, text: '時刻' },
                            ticks: { autoSkip: true, maxTicksLimit: 8 }
                        },
                        y: {
                            display: false,
                            min: 0,
                            max: 2
                        }
                    }
                }
            });
        }
        // CSVダウンロード
        async function downloadCSV() {
            const data = await fetch('/api/history').then(r => r.json());
            let csv = '階/デバイス,混雑度,CO₂,温度,湿度,時刻\n';
            csv += data.map(row => `${row.device_id || row.floor_number},${row.congestion_level || ''},${row.co2_ppm || ''},${row.temperature || ''},${row.humidity || ''},${row.measured_at}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'history.csv';
            a.click();
        }
        // 初期ロード
        // 今日の日付をデフォルトでセット
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('rangeSelect').value = 'day';
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
            fetchRealtime();
            fetchHistory();
            setInterval(fetchRealtime, 5000);
        });
    </script>
</body>

</html>